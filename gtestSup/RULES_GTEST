# Definitions for Google Test

# GTEST_HOME - pointer to the Google Test location
#   <not set> = do not use gtest
#   SYSTEM    = libraries and headers are in a system location
#   <path>    = libraries and headers are under <path>

# A special version of gtest_main (that provides TAP output)
# is provided by EPICS Base in library epics_gtest_main

ifdef GTEST_HOME

ifeq ($(GTEST_HOME),SYSTEM)
define gtest_prod_template
  $(1)_SYS_LIBS += gtest epics_gtest_main pthread
endef
else
define gtest_prod_template
  $(1)_SYS_LIBS += pthread
  $(1)_LIBS += gtest epics_gtest_main
  $(1)_INCLUDES += -I$(GTEST_HOME)/googletest/include
endef
gtest_DIR = $(GTEST_HOME)/googletest
endif

$(foreach testprod, $(GTESTPROD_HOST), $(eval $(call gtest_prod_template,$(testprod))))
TESTPROD_HOST += $(GTESTPROD_HOST)

# Enable testing if this host can run tests on the current target
ifneq (,$(findstring $(T_A),$(EPICS_HOST_ARCH) $(CROSS_COMPILER_RUNTEST_ARCHS)))
  RUNTESTS_ENABLED = YES
  # workaround for missing $(strip ) in base's RULES_BUILD test-results: recipe (352ff.)
  ifneq (,$(strip $(GTEST_SUITES)))
    TAPFILES += $(addsuffix .tap,$(GTEST_SUITES))
  endif
endif

#---------------------------------------------------------------
# Automated testing

RUN_GTESTS = $(addsuffix .run,$(GTESTS))

.PHONY: $(RUN_GTESTS)
runtests:: $(RUN_GTESTS)
tapfiles: $(RUN_GTESTS)

$(RUN_GTESTS): %.run: %$(EXE)
ifdef RUNTESTS_ENABLED
	./$(basename $@)$(EXE)
endif

endif
