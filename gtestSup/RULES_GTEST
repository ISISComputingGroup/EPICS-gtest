# Definitions for Google Test

# GTEST_HOME - pointer to the Google Test location
#   <not set> = do not use gtest
#   SYSTEM    = libraries and headers are in a system location
#               (deprecated)
#   <path>    = libraries and headers are under <path>

# A special version of gtest_main (that provides TAP output)
# is provided by EPICS Base in library epics_gtest_main

ifdef GTEST_HOME

ifeq ($(GTEST_HOME),SYSTEM)
define gtest_prod_template
  $(1)_SYS_LIBS += gtest epics_gtest_main pthread
endef
else
define gtest_prod_template
  $(1)_SYS_LIBS += pthread
  $(1)_LIBS += gtest epics_gtest_main
  $(1)_INCLUDES += -I$(GTEST_HOME)/googletest/include
endef
gtest_DIR = $(GTEST_HOME)/googletest
endif

$(foreach testprod, $(GTESTPROD_HOST), $(eval $(call gtest_prod_template,$(testprod))))
TESTPROD_HOST += $(GTESTPROD_HOST)

# Enable testing if this host can run tests for the current target
ifneq (,$(findstring $(T_A),$(EPICS_HOST_ARCH) $(CROSS_COMPILER_RUNTEST_ARCHS)))
RUNTESTS_ENABLED = YES
GTESTLISTS = $(addsuffix .list,$(GTESTS))
JUNITFILES = $(addsuffix .xml,$(GTESTS))
endif

#---------------------------------------------------------------
# Automated testing using Google Test

GTESTS_MAKE = $(addsuffix .make,$(GTESTS))

runtests: $(JUNITFILES)

$(GTESTLISTS): %.list: %$(EXE)
	@$(RM) $@
	@./$< --gtest_list_tests > $@

$(GTESTS_MAKE): %.make: %.list
	@$(RM) $@
	@$(PERL) $(GTEST_BIN)/makeFromList.pl $*

include $(GTESTS_MAKE)

TAPFILES += $(foreach gtest, $(GTESTS), $($(gtest)_TAPFILES))

endif
